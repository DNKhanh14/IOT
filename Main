/* ======================= BLYNK ======================= */
#define BLYNK_TEMPLATE_ID "TMPL6GiZTk8C4"
#define BLYNK_TEMPLATE_NAME "IOT"
#define BLYNK_AUTH_TOKEN "Evxw_G2xM_o3NS5j1Zp8T-CHTGe7siM1"

char ssid[] = "Ngh·ªá An";
char pass[] = "88888888";

/* ======================= LIB ======================= */
#include <Arduino.h>
#include <Wire.h>
#include <Keypad.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_AHTX0.h>
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>

/* ======================= CH√ÇN PH·∫¶N C·ª®NG ======================= */
#define LED_PIN     4
#define BUZZER_PIN  16
#define VIB_PIN     15
#define DO_PIN      35
#define IR_PIN      34
#define FAN_IN1     17
#define FAN_IN2     2

#define TOUCH1 5
#define TOUCH2 18
#define TOUCH3 19
#define TOUCH4 21

#define SDA_PIN 22
#define SCL_PIN 23

/* ======================= OLED ======================= */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

/* ======================= KEYPAD ======================= */
const byte ROWS = 4;
const byte COLS = 4;

char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};

byte rowPins[ROWS] = {26, 25, 33, 32};
byte colPins[COLS] = {27, 14, 13, 12};

Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

/* ======================= AHT20 ======================= */
Adafruit_AHTX0 aht;

/* ======================= BI·∫æN CHUNG ======================= */
float nhietDo = 0;
bool canhBaoRung = false;

/* üëâ GI·ªÆ C·∫¢NH B√ÅO CHO BLYNK */
unsigned long timeCanhBao = 0;
const unsigned long canhBaoHoldTime = 5000;

/* ======================= BI·∫æN RUNG ======================= */
bool dangRung = false;
int rungCount = 0;
unsigned long lastRungTime = 0;
unsigned long firstRungTime = 0;
const unsigned long debounceTime = 300;
const unsigned long windowTime   = 3000;

/* ======================= BI·∫æN OLED ======================= */
char selectedProduct = 0;
bool coVatCham = false;
bool lastState = false;

/* ======================= OLED FUNCTIONS ======================= */
void showHome() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0,0);
  display.println("VENDING MACHINE");
  display.println("----------------");
  display.println("Chon SP: 1 2 3 4");
  display.println("# = XAC NHAN");
  display.println("* = HUY");
  display.display();
}

void showStatus() {
  display.fillRect(0,30,SCREEN_WIDTH,34,SSD1306_BLACK);
  display.setCursor(0,30);
  display.print("SP ");
  display.println(selectedProduct);
  display.println(coVatCham ? "CO SAN PHAM" : "DANG TRONG");
  display.display();
}

/* ===== HI·ªÇN TH·ªä QR GI·∫¢ ===== */
void showQR() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(0,0);
  display.println("THANH TOAN");
  display.println("----------------");
  display.print("SP: ");
  display.println(selectedProduct);

  int startX = 40;
  int startY = 20;
  int blockSize = 4;

  randomSeed(millis());

  for (int y = 0; y < 8; y++) {
    for (int x = 0; x < 8; x++) {
      if (random(0,2))
        display.fillRect(startX + x*blockSize, startY + y*blockSize,
                         blockSize, blockSize, SSD1306_WHITE);
    }
  }
  display.display();
}

bool readTouch(char sp) {
  if (sp=='1') return digitalRead(TOUCH1);
  if (sp=='2') return digitalRead(TOUCH2);
  if (sp=='3') return digitalRead(TOUCH3);
  if (sp=='4') return digitalRead(TOUCH4);
  return false;
}

/* ======================= TASK NHI·ªÜT ƒê·ªò ======================= */
void taskNhietDo(void *pv) {
  while (1) {
    sensors_event_t h, t;
    aht.getEvent(&h, &t);
    nhietDo = t.temperature;

    if (nhietDo > 28) {
      digitalWrite(LED_PIN, HIGH);
      digitalWrite(FAN_IN1, HIGH);
      digitalWrite(FAN_IN2, LOW);
    } else {
      digitalWrite(LED_PIN, LOW);
      digitalWrite(FAN_IN1, LOW);
      digitalWrite(FAN_IN2, LOW);
    }
    vTaskDelay(200 / portTICK_PERIOD_MS);
  }
}

/* ======================= TASK RUNG (FIX BLYNK) ======================= */
void taskRung(void *pv) {
  while (1) {
    int vibState = digitalRead(VIB_PIN);
    unsigned long now = millis();

    if (vibState == HIGH && !dangRung && (now - lastRungTime > debounceTime)) {
      if (rungCount == 0) firstRungTime = now;
      rungCount++;
      dangRung = true;
      lastRungTime = now;
    }

    if (vibState == LOW) dangRung = false;

    if (rungCount > 0 && (now - firstRungTime > windowTime)) {
      rungCount = 0;
    }

    if (rungCount >= 3) {
      canhBaoRung = true;
      timeCanhBao = millis();
      rungCount = 0;
    }
    vTaskDelay(50 / portTICK_PERIOD_MS);
  }
}

/* ======================= TASK IR + √ÅNH S√ÅNG ======================= */
void taskIRLight(void *pv) {
  while (1) {
    if (digitalRead(DO_PIN)==HIGH && digitalRead(IR_PIN)==LOW) {
      digitalWrite(LED_PIN, HIGH);
    }
    vTaskDelay(100 / portTICK_PERIOD_MS);
  }
}

/* ======================= TASK OLED + KEYPAD ======================= */
void taskOLED(void *pv) {
  while (1) {
    char key = keypad.getKey();

    if (key>='1' && key<='4') {
      selectedProduct = key;
      coVatCham = readTouch(key);
      lastState = coVatCham;
      showStatus();
    }

    if (key=='#') {
      if (selectedProduct && coVatCham) {
        showQR();
        vTaskDelay(3000 / portTICK_PERIOD_MS);
        showHome();
      }
      selectedProduct = 0;
      coVatCham = false;
    }

    if (key=='*') {
      selectedProduct = 0;
      coVatCham = false;
      showHome();
    }

    if (selectedProduct) {
      bool cur = readTouch(selectedProduct);
      if (cur != lastState) {
        coVatCham = cur;
        lastState = cur;
        showStatus();
      }
    }

    vTaskDelay(100 / portTICK_PERIOD_MS);
  }
}

/* ======================= SETUP ======================= */
void setup() {
  Serial.begin(9600);

  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(VIB_PIN, INPUT);
  pinMode(DO_PIN, INPUT);
  pinMode(IR_PIN, INPUT);
  pinMode(FAN_IN1, OUTPUT);
  pinMode(FAN_IN2, OUTPUT);

  pinMode(TOUCH1, INPUT);
  pinMode(TOUCH2, INPUT);
  pinMode(TOUCH3, INPUT);
  pinMode(TOUCH4, INPUT);

  Wire.begin(SDA_PIN, SCL_PIN);
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  showHome();

  aht.begin();
  WiFi.begin(ssid, pass);
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);

  xTaskCreatePinnedToCore(taskNhietDo, "Temp", 8192, NULL, 1, NULL, 1);
  xTaskCreatePinnedToCore(taskRung, "Vib", 4096, NULL, 1, NULL, 1);
  xTaskCreatePinnedToCore(taskIRLight, "IR", 4096, NULL, 1, NULL, 1);
  xTaskCreatePinnedToCore(taskOLED, "OLED", 4096, NULL, 1, NULL, 1);
}

/* ======================= LOOP ======================= */
void loop() {
  Blynk.run();

  static unsigned long lastSend = 0;
  if (millis() - lastSend > 1000) {
    Blynk.virtualWrite(V0, nhietDo);
    Blynk.virtualWrite(V1, canhBaoRung ? "CANH BAO" : "BINH THUONG");
    Blynk.virtualWrite(V2, digitalRead(TOUCH1)?"CO":"KHONG");
    Blynk.virtualWrite(V3, digitalRead(TOUCH2)?"CO":"KHONG");
    Blynk.virtualWrite(V4, digitalRead(TOUCH3)?"CO":"KHONG");
    Blynk.virtualWrite(V5, digitalRead(TOUCH4)?"CO":"KHONG");
    Blynk.virtualWrite(V6, digitalRead(IR_PIN)==LOW?"CO VAT":"KHONG");
    Blynk.virtualWrite(V7, digitalRead(DO_PIN)==LOW?"SANG":"TOI");
    lastSend = millis();
  }

  if (canhBaoRung) {
    digitalWrite(BUZZER_PIN, HIGH);
    delay(200);
    digitalWrite(BUZZER_PIN, LOW);

    if (millis() - timeCanhBao > canhBaoHoldTime) {
      canhBaoRung = false;
    }
  }
}
